# v1.1.0 Deployment Guide - Display Modes & Tile Counter

## Quick Reference

**Version**: v1.1.0
**Release Date**: January 30, 2025
**Upgrade Time**: 2-4 hours
**Downtime Required**: No (backward compatible)

## What's New in v1.1.0

‚ú® **Display Modes**: Choose how notifications appear (BANNER, TOAST, BOTH, SILENT)
üìä **Dynamic Tile Counter**: Real-time statistics on FLP tile
üéõÔ∏è **Custom Domains**: Fixed value validation with automatic F4 help
üìù **Audit Trail**: Track notification lifecycle with timestamps

## Pre-Deployment Checklist

- [ ] Backup ZTNOTIFY_MSGS table
- [ ] Review current v1.0.0 installation
- [ ] SAP S/4HANA PCE 2023 or higher
- [ ] Transport request created
- [ ] Development/Test system available

## Deployment Steps

### Step 1: Create Custom Domains (SE11)

Create 4 custom domains with fixed values:

#### 1.1 ZDOMAIN_MSG_TYPE
```
Transaction: SE11 ‚Üí Domain
Domain Name: ZDOMAIN_MSG_TYPE
Data Type: CHAR, Length: 12

Fixed Values (Value Range tab):
- URGENT    | Urgent System Message
- INFO      | Informational Message
- TIP       | Helpful Tip
- SUCCESS   | Success Notification
- MAINT     | Scheduled Maintenance
- WARNING   | Warning Message
```

#### 1.2 ZDOMAIN_SEVERITY
```
Transaction: SE11 ‚Üí Domain
Domain Name: ZDOMAIN_SEVERITY
Data Type: CHAR, Length: 8

Fixed Values:
- HIGH      | High Priority (Critical/Error)
- MEDIUM    | Medium Priority (Warning)
- LOW       | Low Priority (Info)
```

#### 1.3 ZDOMAIN_DISPLAY_MODE
```
Transaction: SE11 ‚Üí Domain
Domain Name: ZDOMAIN_DISPLAY_MODE
Data Type: CHAR, Length: 10

Fixed Values:
- BANNER    | Fixed Top Banner
- TOAST     | Toast Notification (5s)
- BOTH      | Banner + Toast
- SILENT    | Silent (Log Only)
```

#### 1.4 ZDOMAIN_TARGET_USERS
```
Transaction: SE11 ‚Üí Domain
Domain Name: ZDOMAIN_TARGET_USERS
Data Type: CHAR, Length: 255

No Fixed Values (free text with pattern matching)
```

**Save and Activate** all 4 domains.

---

### Step 2: Create Data Elements (SE11)

Create 4 data elements based on the domains:

#### 2.1 ZNOTIFY_MSG_TYPE
```
Transaction: SE11 ‚Üí Data Type
Data Element: ZNOTIFY_MSG_TYPE
Domain: ZDOMAIN_MSG_TYPE

Field Labels:
- Short: Msg Type
- Medium: Message Type
- Long: Notification Message Type
```

#### 2.2 ZNOTIFY_SEVERITY
```
Transaction: SE11 ‚Üí Data Type
Data Element: ZNOTIFY_SEVERITY
Domain: ZDOMAIN_SEVERITY

Field Labels:
- Short: Severity
- Medium: Severity Level
- Long: Notification Severity Level
```

#### 2.3 ZNOTIFY_DISP_MODE
```
Transaction: SE11 ‚Üí Data Type
Data Element: ZNOTIFY_DISP_MODE
Domain: ZDOMAIN_DISPLAY_MODE

Field Labels:
- Short: Display
- Medium: Display Mode
- Long: Notification Display Mode
```

#### 2.4 ZNOTIFY_TARGET_USERS
```
Transaction: SE11 ‚Üí Data Type
Data Element: ZNOTIFY_TARGET_USERS
Domain: ZDOMAIN_TARGET_USERS

Field Labels:
- Short: Target
- Medium: Target Users
- Long: Target Audience Filter
```

**Save and Activate** all 4 data elements.

---

### Step 3: Adjust Table Structure (SE14)

Modify ZTNOTIFY_MSGS table to add new fields and use custom data elements:

#### 3.1 Change Existing Fields (SE11)
```
Transaction: SE11 ‚Üí Database Table ‚Üí ZTNOTIFY_MSGS ‚Üí Change

Modify these fields:
- MESSAGE_TYPE: Change data element from CHAR10 to ZNOTIFY_MSG_TYPE
- SEVERITY: Change data element from CHAR10 to ZNOTIFY_SEVERITY
- TARGET_USERS: Change data element from CHAR255 to ZNOTIFY_TARGET_USERS
```

#### 3.2 Add New Fields
```
Add after ACTIVE field:
- DISPLAY_MODE  : Data Element ZNOTIFY_DISP_MODE

Add at end:
- CREATED_BY    : Data Element SYUNAME
- CREATED_AT    : Data Element TIMESTAMPL
- CHANGED_BY    : Data Element SYUNAME
- CHANGED_AT    : Data Element TIMESTAMPL
```

#### 3.3 Adjust Table (SE14)
```
Transaction: SE14
Table Name: ZTNOTIFY_MSGS
Click "Edit" ‚Üí "Adjust"
Select "Adjust table in database"
Execute adjustment
```

**‚ö†Ô∏è IMPORTANT**: Table adjustment will preserve existing data.

---

### Step 4: Update CDS View (SE11)

Modify ZTNOTIFY_MESSAGES CDS view:

```sql
@AbapCatalog.sqlViewName: 'ZNOTIFY_MSG'
@AbapCatalog.compiler.compareFilter: true
@AbapCatalog.preserveKey: true
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Global Notification Messages'
@OData.publish: true

define view ZTNOTIFY_MESSAGES as select from ztnotify_msgs {
    key client,
    key message_id,
    message_type,
    severity,
    title,
    message_text,
    start_date,
    end_date,
    target_users,
    active,
    display_mode,        // ‚Üê NEW
    created_by,          // ‚Üê NEW
    created_at,          // ‚Üê NEW
    changed_by,          // ‚Üê NEW
    changed_at           // ‚Üê NEW
}
where active = 'X'
  and start_date <= $session.system_date
  and end_date >= $session.system_date
```

**Activate** the CDS view.

---

### Step 5: Update ABAP Classes (SE24/SE80)

#### 5.1 Update ZCL_NOTIFICATION_MANAGER

Add display_mode and audit fields to ty_notification structure:

```abap
TYPES: BEGIN OF ty_notification,
         message_id   TYPE string,
         message_type TYPE string,
         severity     TYPE string,
         title        TYPE string,
         message_text TYPE string,
         start_date   TYPE dats,
         end_date     TYPE dats,
         target_users TYPE string,
         active       TYPE char1,
         display_mode TYPE char10,        " ‚Üê NEW
         created_by   TYPE syuname,       " ‚Üê NEW
         created_at   TYPE timestampl,    " ‚Üê NEW
         changed_by   TYPE syuname,       " ‚Üê NEW
         changed_at   TYPE timestampl,    " ‚Üê NEW
       END OF ty_notification.
```

Update SELECT statements to include new fields.

See: `abap/zcl_notification_manager.clas.abap`

#### 5.2 Update ZCL_NOTIFICATION_REST

Add routing for new endpoints:

```abap
METHOD if_rest_resource~get.
  DATA: lv_path TYPE string.

  lv_path = mo_request->get_uri_path( ).

  CASE lv_path.
    WHEN '/stats'.
      handle_get_stats( ).        " ‚Üê NEW
    WHEN '/log'.
      handle_get_log( ).          " ‚Üê NEW
    WHEN OTHERS.
      handle_get_notifications( ).
  ENDCASE.
ENDMETHOD.
```

Add methods `handle_get_stats` and `handle_get_log`.

See: `abap/zcl_notification_rest.clas.abap`

**Activate** both classes.

---

### Step 6: Run Migration Script (SE38)

Execute the migration script to set default values for existing notifications:

```
Transaction: SE38
Program: Z_MIGRATE_NOTIFY_V11
Execute (F8)

Expected Output:
‚úì DISPLAY_MODE field detected in table
Found X notification(s) to migrate
‚úì Updated: MSG-001 - System Maintenance -> BANNER
‚úì Updated: MSG-002 - Feature Update -> BANNER
...
‚úì Migration completed successfully!
```

**Verify**: Transaction SE16 ‚Üí ZTNOTIFY_MSGS ‚Üí Check DISPLAY_MODE = 'BANNER'

---

### Step 7: Deploy Frontend (UI5 Application)

#### 7.1 Build Application
```bash
cd sap-fiori-notification-banner
npm install
npm run build
```

#### 7.2 Upload to BSP (Option A: Manual)
```
Transaction: SE80
Object Navigator ‚Üí BSP Application ‚Üí ZNOTIFY_BANNER
Import ‚Üí Select dist/*.* files
Activate all
```

#### 7.3 Upload to BSP (Option B: Fiori Tools)
```bash
npx fiori deploy
```

#### 7.4 Clear Browser Cache
```
Users must clear browser cache or do hard refresh (Ctrl+F5)
```

---

### Step 8: Test All Features

#### 8.1 Test Display Modes

Create test notifications via SM30:

```
Transaction: SM30
Table: ZTNOTIFY_MSGS

Test 1: BANNER mode
- Title: "Test Banner"
- DISPLAY_MODE: BANNER
- Expected: Fixed top banner, user must close

Test 2: TOAST mode
- Title: "Test Toast"
- DISPLAY_MODE: TOAST
- Expected: Bottom-right toast, auto-dismiss 5s

Test 3: BOTH mode
- Title: "Test Both"
- DISPLAY_MODE: BOTH
- Expected: Both banner and toast appear

Test 4: SILENT mode
- Title: "Test Silent"
- DISPLAY_MODE: SILENT
- Expected: No UI, check console logs
```

#### 8.2 Test Tile Counter

```
1. Create notifications with different severities:
   - 3 HIGH
   - 5 MEDIUM
   - 2 LOW

2. Open FLP
3. Verify tile shows:
   - "10 Active"
   - "3H|5M|2L"
   - RED color (‚â•3 HIGH)

4. Wait 60 seconds
5. Verify tile auto-updates
```

#### 8.3 Test F4 Help

```
Transaction: SM30
Table: ZTNOTIFY_MSGS
Click on MESSAGE_TYPE field ‚Üí Press F4
Expected: Dropdown shows URGENT, INFO, TIP, SUCCESS, MAINT, WARNING

Repeat for:
- SEVERITY ‚Üí HIGH, MEDIUM, LOW
- DISPLAY_MODE ‚Üí BANNER, TOAST, BOTH, SILENT
```

#### 8.4 Test REST API

```javascript
// Test /stats endpoint
jQuery.ajax({
    url: "/sap/bc/rest/zcl_notification_rest/stats",
    type: "GET",
    success: function(data) {
        console.log("Stats:", data);
        // Expected: {total: 10, high_count: 3, medium_count: 5, low_count: 2}
    }
});

// Test /log endpoint
jQuery.ajax({
    url: "/sap/bc/rest/zcl_notification_rest/log",
    type: "GET",
    success: function(data) {
        console.log("Silent notifications log:", data);
    }
});
```

---

## Verification Checklist

- [ ] All 4 domains created and activated
- [ ] All 4 data elements created and activated
- [ ] ZTNOTIFY_MSGS table adjusted (SE14)
- [ ] CDS view updated and activated
- [ ] ZCL_NOTIFICATION_MANAGER updated and activated
- [ ] ZCL_NOTIFICATION_REST updated and activated
- [ ] Migration script executed successfully
- [ ] Frontend deployed to BSP
- [ ] Browser cache cleared
- [ ] BANNER mode tested ‚úÖ
- [ ] TOAST mode tested ‚úÖ
- [ ] BOTH mode tested ‚úÖ
- [ ] SILENT mode tested ‚úÖ
- [ ] Tile counter displays correctly ‚úÖ
- [ ] F4 help works in SM30 ‚úÖ
- [ ] /stats endpoint returns data ‚úÖ
- [ ] /log endpoint returns data ‚úÖ

---

## Rollback Plan

If issues occur, rollback using these steps:

### Rollback Step 1: Restore Table Structure
```
Transaction: SE14
Table: ZTNOTIFY_MSGS
Adjust ‚Üí Select previous version
Execute
```

### Rollback Step 2: Restore Frontend
```
Deploy previous version from backup
Or revert Git commit:
git revert HEAD
npm run build
Deploy to BSP
```

### Rollback Step 3: Restore Data
```sql
-- If table backup exists
DELETE FROM ztnotify_msgs.
INSERT INTO ztnotify_msgs SELECT * FROM ztnotify_msgs_backup.
```

---

## Troubleshooting

### Issue: F4 Help Not Working

**Cause**: Domains or data elements not activated
**Solution**:
```
SE11 ‚Üí Check domain active status
SE11 ‚Üí Check data element active status
Activate if needed
```

### Issue: Migration Script Fails

**Cause**: DISPLAY_MODE field not in table yet
**Solution**:
```
Run SE14 table adjustment first
Then run migration script
```

### Issue: Tile Counter Not Updating

**Cause**: REST endpoint not accessible
**Solution**:
```
Test: /sap/bc/rest/zcl_notification_rest/stats
Check SICF service is active
Check ZCL_NOTIFICATION_REST is activated
```

### Issue: Toast Not Appearing

**Cause**: Browser cache
**Solution**:
```
Hard refresh: Ctrl+F5 (Windows) / Cmd+Shift+R (Mac)
Clear browser cache completely
```

---

## Post-Deployment Tasks

1. **Notify Users**
   - Send email about new display mode options
   - Update internal wiki documentation

2. **Train Administrators**
   - Show how to use display mode selector
   - Explain when to use each mode

3. **Monitor Performance**
   - Check tile counter performance
   - Monitor REST endpoint response times

4. **Create Standard Notifications**
   - Update existing notifications with appropriate display modes
   - Create templates for common scenarios

---

## Support

For deployment issues:
- üìß Email: gabriele.rendina@lutech.it
- üìñ Full Documentation: [ENHANCEMENT_PLAN.md](../ENHANCEMENT_PLAN.md)
- üéØ Admin UI Guide: [ADMIN_UI_DISPLAY_MODE.md](./ADMIN_UI_DISPLAY_MODE.md)
- üèóÔ∏è Custom Domains: [domains/README.md](../abap/domains/README.md)

---

**Deployment Time Estimate**: 2-4 hours
**Recommended Window**: Non-peak hours, no downtime required
**Backward Compatible**: Yes, v1.0.0 notifications continue to work
