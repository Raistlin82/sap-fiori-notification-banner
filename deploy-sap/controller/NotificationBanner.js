sap.ui.define(["sap/ui/base/Object","sap/m/MessageStrip","sap/m/MessageToast","sap/m/Button","sap/m/Text","sap/ui/core/library","sap/ui/model/json/JSONModel","sap/base/Log"],function(t,e,i,n,r,s,o,a){"use strict";var c=s.MessageType;return t.extend("com.sap.notifications.banner2.controller.NotificationBanner",{constructor:function(){t.apply(this,arguments);this._notifications=[];this._bannerContainer=null;this._currentBannerIndex=0;this._currentBanner=null;this._model=new o;this._isAttachedToShell=false;this._retryCount=0;this._maxRetries=3;this._retryDelay=1e3;this._consecutiveErrors=0;this._maxConsecutiveErrors=5;this._isCircuitOpen=false;this._circuitResetTimeout=null},loadNotifications:function(){var t=this;if(this._isCircuitOpen){a.warning("Circuit breaker is open, skipping notification load");return}var e="ANONYMOUS";try{if(typeof sap!=="undefined"&&sap.ushell&&sap.ushell.Container){e=sap.ushell.Container.getUser().getId()}}catch(t){a.warning("Could not retrieve user ID from FLP, using ANONYMOUS: "+t.message)}jQuery.ajax({url:"/sap/bc/rest/zcl_notif_rest/",type:"GET",data:{user_id:e},timeout:1e4,success:function(e){t._retryCount=0;t._consecutiveErrors=0;t._retryDelay=1e3;t._processNotifications(e)},error:function(e,i,n){t._handleLoadError(e,i,n)}})},_handleLoadError:function(t,e,i){var n=this;this._consecutiveErrors++;a.error("Failed to load notifications (attempt "+(this._retryCount+1)+"): "+i+" (Status: "+t.status+", Consecutive errors: "+this._consecutiveErrors+")");if(this._consecutiveErrors>=this._maxConsecutiveErrors){this._openCircuitBreaker();return}if(this._retryCount<this._maxRetries){this._retryCount++;var r=this._retryDelay*Math.pow(2,this._retryCount-1);a.info("Retrying notification load in "+r+"ms (retry "+this._retryCount+"/"+this._maxRetries+")");setTimeout(function(){n.loadNotifications()},r)}else{this._retryCount=0;this._showErrorBanner(i,t.status)}},_openCircuitBreaker:function(){var t=this;this._isCircuitOpen=true;this._retryCount=0;a.warning("Circuit breaker opened after "+this._consecutiveErrors+" consecutive errors. "+"Will attempt to reset in 60 seconds.");this._showErrorBanner("Service temporarily unavailable",503);if(this._circuitResetTimeout){clearTimeout(this._circuitResetTimeout)}this._circuitResetTimeout=setTimeout(function(){t._resetCircuitBreaker()},6e4)},_resetCircuitBreaker:function(){this._isCircuitOpen=false;this._consecutiveErrors=0;this._circuitResetTimeout=null;a.info("Circuit breaker reset, resuming normal operation");this._removeBanner();this.loadNotifications()},_showErrorBanner:function(t,i){if(!this._isAttachedToShell){return}this._removeBanner();var n="Unable to load system notifications";if(i===503){n="Notification service is temporarily unavailable. Please try again later."}else if(i===401||i===403){n="You don't have permission to view system notifications"}else if(i===0){n="Cannot connect to notification service. Check your network connection."}this._currentBanner=new e({text:n,type:c.Error,showIcon:true,showCloseButton:true,class:"sapUiMediumMargin notificationBanner notificationBanner--error",close:this._onErrorBannerClose.bind(this)});this._insertBannerInShell()},_onErrorBannerClose:function(){this._removeBanner();this._consecutiveErrors=0;this._retryCount=0},_processNotifications:function(t){var e=false;if(t.length!==this._notifications.length){e=true}else{for(var i=0;i<t.length;i++){var n=this._notifications.find(function(e){return e.message_id===t[i].message_id});if(!n||n.changed_at!==t[i].changed_at){e=true;break}}}if(e){this._notifications=t;this._displayNotifications()}},_displayNotifications:function(){if(!this._isAttachedToShell){return}this._removeBanner();var t=[];var e=[];var i=[];var n=[];for(var r=0;r<this._notifications.length;r++){var s=this._notifications[r];var o=(s.display_mode||"BANNER").toUpperCase();switch(o){case"BANNER":t.push(s);break;case"TOAST":e.push(s);break;case"BOTH":i.push(s);break;case"SILENT":n.push(s);break;default:t.push(s)}}if(t.length>0){this._notifications=t;this._currentBannerIndex=0;this._showBanner()}for(var a=0;a<e.length;a++){this._showToast(e[a])}if(i.length>0){this._notifications=this._notifications.concat(i);if(t.length===0){this._currentBannerIndex=0;this._showBanner()}for(var c=0;c<i.length;c++){this._showToast(i[c])}}for(var h=0;h<n.length;h++){this._logNotification(n[h])}},_showToast:function(t){var e=t.title+": "+t.message_text;i.show(e,{duration:5e3,width:"25em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",autoClose:true})},_logNotification:function(t){a.info("SILENT NOTIFICATION: ["+t.severity+"] "+t.title+": "+t.message_text,"notification_id: "+t.message_id)},_updateBanner:function(){if(!this._isAttachedToShell){return}this._removeBanner();if(this._notifications.length>0){this._showBanner()}},_showBanner:function(){if(this._notifications.length===0){return}var t=this._notifications[this._currentBannerIndex];var i=this._getMessageType(t.severity);this._currentBanner=new e({text:t.title+": "+t.message_text,type:i,showIcon:true,showCloseButton:true,class:"sapUiMediumMargin notificationBanner "+"notificationBanner--"+t.severity.toLowerCase(),close:this._onBannerClose.bind(this)});if(this._notifications.length>1){var s=new n({icon:"sap-icon://navigation-left-arrow",type:"Transparent",press:this._showPreviousNotification.bind(this),tooltip:"Previous notification"});var o=new n({icon:"sap-icon://navigation-right-arrow",type:"Transparent",press:this._showNextNotification.bind(this),tooltip:"Next notification"});var a=new r({text:this._currentBannerIndex+1+" of "+this._notifications.length});this._currentBanner.addAggregation("_formattedText",s);this._currentBanner.addAggregation("_formattedText",a);this._currentBanner.addAggregation("_formattedText",o)}this._insertBannerInShell()},_insertBannerInShell:function(){var t=jQuery("#shell-header")[0]||jQuery(".sapUshellShellHeader")[0]||jQuery("body")[0];if(t){var e=jQuery("<div id='globalNotificationBanner'></div>");if(t.tagName==="BODY"){e.prependTo(jQuery(t))}else{e.insertAfter(jQuery(t))}this._currentBanner.placeAt("globalNotificationBanner");this._bannerContainer=e[0]}},_removeBanner:function(){if(this._currentBanner){this._currentBanner.destroy();this._currentBanner=null}if(this._bannerContainer){jQuery(this._bannerContainer).remove();this._bannerContainer=null}},_onBannerClose:function(){this._notifications.splice(this._currentBannerIndex,1);if(this._currentBannerIndex>=this._notifications.length){this._currentBannerIndex=0}this._updateBanner()},_showPreviousNotification:function(){if(this._notifications.length<=1){return}this._currentBannerIndex--;if(this._currentBannerIndex<0){this._currentBannerIndex=this._notifications.length-1}this._updateBanner()},_showNextNotification:function(){if(this._notifications.length<=1){return}this._currentBannerIndex++;if(this._currentBannerIndex>=this._notifications.length){this._currentBannerIndex=0}this._updateBanner()},_getMessageType:function(t){switch(t.toUpperCase()){case"HIGH":return c.Error;case"MEDIUM":return c.Warning;case"LOW":return c.Information;default:return c.Information}},attachToShell:function(){this._isAttachedToShell=true;this.loadNotifications()},destroy:function(){this._removeBanner();t.prototype.destroy.apply(this,arguments)}})});
//# sourceMappingURL=NotificationBanner.js.map